name: Update Data from VK Cloud

on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-data.yml'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install pandas openpyxl requests
    
    - name: Download Excel from VK Cloud
      env:
        FILE_URL: "https://cloud.mail.ru/public/YOUR_FILE_CODE/CreditMarket_Data.xlsx?download=1"
      run: |
        # –ó–ê–ú–ï–ù–ò–¢–ï YOUR_FILE_CODE –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ —Å—Å—ã–ª–∫–∏ VK
        curl -L -o data.xlsx "$FILE_URL"
        echo "File downloaded: $(ls -la data.xlsx)"
    
    - name: Convert to JSON
      run: |
        python << 'EOF'
        import pandas as pd
        import json
        import os
        
        os.makedirs('data', exist_ok=True)
        
        # –ß–∏—Ç–∞–µ–º Excel
        xls = pd.ExcelFile('data.xlsx')
        
        # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Å—Ç–∞
        for sheet in xls.sheet_names:
            df = pd.read_excel(xls, sheet_name=sheet)
            # –û—á–∏—â–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            df = df.dropna(how='all')
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ JSON
            output_file = f'data/{sheet.lower()}.json'
            df.to_json(output_file, orient='records', force_ascii=False, indent=2)
            print(f"‚úÖ Saved: {output_file} ({len(df)} rows)")
        
        print("üéâ All sheets converted!")
        EOF
    
    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add data/*.json
        git diff --staged --quiet || git commit -m "ü§ñ Auto-update data $(date '+%Y-%m-%d %H:%M')"
        git push
