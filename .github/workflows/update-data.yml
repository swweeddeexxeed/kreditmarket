name: üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ VK –û–±–ª–∞–∫–∞

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: ‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # 2. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É data (–µ—Å–ª–∏ –µ—Å—Ç—å)
    - name: üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ data..."
        if [ -d "data" ]; then
          echo "–£–¥–∞–ª—è—é —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É data..."
          rm -rf data
          echo "‚úÖ –ü–∞–ø–∫–∞ data —É–¥–∞–ª–µ–Ω–∞"
        else
          echo "‚úÖ –ü–∞–ø–∫–∏ data –Ω–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
        fi
    
    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        pip install pandas openpyxl xlrd
        echo "‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    # 5. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    - name: ‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–µ–º Excel –∏–∑ VK –û–±–ª–∞–∫–∞
      run: |
        echo "–ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ..."
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Å –≤–∞—à–µ–π —Å—Å—ã–ª–∫–æ–π
        wget -O creditmarket_data.xlsx "https://cloud.mail.ru/public/4Nef/r6uipVAxF?download=1"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–∞—á–∞–ª—Å—è –ª–∏ —Ñ–∞–π–ª
        if [ ! -f "creditmarket_data.xlsx" ]; then
          echo "‚ùå –§–∞–π–ª –Ω–µ —Å–∫–∞—á–∞–ª—Å—è!"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
        FILESIZE=$(stat -c%s "creditmarket_data.xlsx")
        echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $FILESIZE –±–∞–π—Ç"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 100 –±–∞–π—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        echo "–ü–µ—Ä–≤—ã–µ 100 –±–∞–π—Ç —Ñ–∞–π–ª–∞ (hexdump):"
        hexdump -C -n 100 creditmarket_data.xlsx
        
        # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è Excel (–æ–±—ã—á–Ω–æ > 4KB)
        if [ $FILESIZE -lt 4096 ]; then
          echo "‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π! –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –æ—à–∏–±–∫–æ–π."
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:"
          cat creditmarket_data.xlsx
          exit 1
        fi
        
        echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω"
    
    # 6. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JSON
    - name: üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Excel ‚Üí JSON
      run: |
        python << 'EOF'
        import pandas as pd
        import os
        import json
        
        print("=== –ù–ê–ß–ê–õ–û –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ===")
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É data
        os.makedirs('data', exist_ok=True)
        print("‚úÖ –ü–∞–ø–∫–∞ 'data' —Å–æ–∑–¥–∞–Ω–∞")
        
        excel_path = "creditmarket_data.xlsx"
        
        try:
            # –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å Excel —Ñ–∞–π–ª
            print("–ü—Ä–æ–±—É—é –ø—Ä–æ—á–∏—Ç–∞—Ç—å Excel —Ñ–∞–π–ª...")
            
            # –ú–µ—Ç–æ–¥ 1: —á–µ—Ä–µ–∑ openpyxl (–¥–ª—è .xlsx)
            try:
                xls = pd.ExcelFile(excel_path, engine='openpyxl')
                print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑ openpyxl! –õ–∏—Å—Ç—ã: {xls.sheet_names}")
            except:
                # –ú–µ—Ç–æ–¥ 2: —á–µ—Ä–µ–∑ xlrd (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö .xls)
                try:
                    xls = pd.ExcelFile(excel_path, engine='xlrd')
                    print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑ xlrd! –õ–∏—Å—Ç—ã: {xls.sheet_names}")
                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel: {e}")
                    raise
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ª–∏—Å—Ç
            for sheet_name in xls.sheet_names:
                print(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ª–∏—Å—Ç: '{sheet_name}'")
                
                try:
                    # –ß–∏—Ç–∞–µ–º –ª–∏—Å—Ç
                    df = pd.read_excel(xls, sheet_name=sheet_name)
                    
                    # –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                    df = df.dropna(how='all')
                    
                    # –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç–æ–ª–±—Ü—ã
                    df = df.dropna(axis=1, how='all')
                    
                    if df.empty:
                        print(f"‚ö†Ô∏è –õ–∏—Å—Ç '{sheet_name}' –ø—É—Å—Ç")
                        df = pd.DataFrame({'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è': ['–õ–∏—Å—Ç –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö']})
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSON
                    safe_name = sheet_name.lower().replace(' ', '_')
                    output_file = f'data/{safe_name}.json'
                    
                    df.to_json(output_file, orient='records', force_ascii=False, indent=2)
                    print(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: {output_file} ({len(df)} —Å—Ç—Ä–æ–∫)")
                    
                except Exception as e:
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–∏—Å—Ç–∞ '{sheet_name}': {e}")
                    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –æ—à–∏–±–∫–æ–π
                    error_data = {"–æ—à–∏–±–∫–∞": f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ª–∏—Å—Ç: {str(e)}"}
                    with open(f'data/{sheet_name.lower()}_error.json', 'w') as f:
                        json.dump(error_data, f, ensure_ascii=False, indent=2)
            
            print("üéâ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
            
        except Exception as e:
            print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
            
            # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
            error_info = {
                "–æ—à–∏–±–∫–∞": str(e),
                "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": [
                    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º Excel-—Ñ–∞–π–ª–æ–º",
                    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª",
                    "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç"
                ]
            }
            
            with open('data/–æ—à–∏–±–∫–∞_–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.json', 'w') as f:
                json.dump(error_info, f, ensure_ascii=False, indent=2)
            
            exit(1)
        EOF
    
    # 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      run: |
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–ª–∏—Å—å –ª–∏ —Ñ–∞–π–ª—ã
        echo "–ü—Ä–æ–≤–µ—Ä—è—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ data:"
        ls -la data/ || echo "–ü–∞–ø–∫–∞ data –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ data
        git add data/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --staged --quiet; then
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          git commit -m "üìä –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö $(date '+%Y-%m-%d %H:%M')"
          git push
          echo "‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
        fi
    
    # 8. –û—á–∏—Å—Ç–∫–∞
    - name: üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      run: |
        rm -f creditmarket_data.xlsx
        echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
