name: Update Data from VK Cloud

on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:  # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install pandas openpyxl
    
    - name: Download Excel from VK Cloud
      run: |
        # –°–ö–ê–ß–ò–í–ê–ï–ú –í–ê–® –§–ê–ô–õ - –ó–î–ï–°–¨ –í–ê–®–ê –°–°–´–õ–ö–ê
        curl -L -o data.xlsx "https://cloud.mail.ru/public/4Nef/r6uipVAxF?download=1"
        echo "–§–∞–π–ª —Å–∫–∞—á–∞–Ω. –†–∞–∑–º–µ—Ä: $(ls -lh data.xlsx | awk '{print $5}')"
    
    - name: Convert to JSON
      run: |
        python << 'EOF'
        import pandas as pd
        import os
        
        os.makedirs('data', exist_ok=True)
        
        try:
            xls = pd.ExcelFile('data.xlsx')
            print(f"‚úÖ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω. –õ–∏—Å—Ç—ã: {xls.sheet_names}")
            
            for sheet in xls.sheet_names:
                df = pd.read_excel(xls, sheet_name=sheet)
                df = df.dropna(how='all')  # –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                
                # –ï—Å–ª–∏ DataFrame –ø—É—Å—Ç–æ–π, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π JSON
                if df.empty:
                    df = pd.DataFrame(columns=['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'])
                
                output_file = f'data/{sheet.lower()}.json'
                df.to_json(output_file, orient='records', force_ascii=False, indent=2)
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω: {output_file} (—Å—Ç—Ä–æ–∫: {len(df)})")
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –æ—à–∏–±–∫–æ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            with open('data/error.txt', 'w') as f:
                f.write(str(e))
            exit(1)
        EOF
    
    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add data/*.json
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --staged --quiet; then
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö $(date '+%Y-%m-%d %H:%M')"
          git push
        fi
    
    - name: Clean up
      run: rm -f data.xlsx
