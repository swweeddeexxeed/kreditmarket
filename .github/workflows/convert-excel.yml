name: üìä –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Excel –≤ JSON

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  push:
    paths:
      - 'CreditMarket_Data*.xlsx'  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–æ–≤

jobs:
  convert-excel:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: ‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: pip install pandas openpyxl
    
    # 4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Excel –≤ JSON
    - name: üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Excel ‚Üí JSON
      run: |
        python << 'EOF'
        import pandas as pd
        import os
        import json
        
        print("=== –ù–ê–ß–ò–ù–ê–ï–ú –ö–û–ù–í–ï–†–¢–ê–¶–ò–Æ ===")
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É data
        os.makedirs('data', exist_ok=True)
        
        # –ò—â–µ–º Excel —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
        excel_files = [f for f in os.listdir('.') if f.endswith('.xlsx')]
        print(f"–ù–∞–π–¥–µ–Ω—ã Excel —Ñ–∞–π–ª—ã: {excel_files}")
        
        if not excel_files:
            print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ Excel —Ñ–∞–π–ª–æ–≤!")
            exit(1)
        
        # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π Excel —Ñ–∞–π–ª
        excel_file = excel_files[0]
        print(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª: {excel_file}")
        
        try:
            # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
            xls = pd.ExcelFile(excel_file)
            print(f"‚úÖ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω. –õ–∏—Å—Ç—ã: {xls.sheet_names}")
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –ª–∏—Å—Ç
            for sheet_name in xls.sheet_names:
                print(f"üìã –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ª–∏—Å—Ç: '{sheet_name}'")
                
                df = pd.read_excel(xls, sheet_name=sheet_name)
                
                # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                df = df.dropna(how='all')  # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                df = df.dropna(axis=1, how='all')  # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç–æ–ª–±—Ü—ã
                
                # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
                if df.empty:
                    print(f"‚ö†Ô∏è –õ–∏—Å—Ç '{sheet_name}' –ø—É—Å—Ç")
                    df = pd.DataFrame({'–°–æ–æ–±—â–µ–Ω–∏–µ': [f'–õ–∏—Å—Ç "{sheet_name}" –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö']})
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ JSON
                safe_name = sheet_name.lower().replace(' ', '_').replace('-', '_')
                output_file = f'data/{safe_name}.json'
                
                df.to_json(output_file, orient='records', force_ascii=False, indent=2)
                print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {output_file} ({len(df)} —Å—Ç—Ä–æ–∫)")
            
            print("üéâ –í—Å–µ –ª–∏—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {e}")
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
            error_info = {
                "–æ—à–∏–±–∫–∞": str(e),
                "—Ñ–∞–π–ª": excel_file,
                "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç Excel —Ñ–∞–π–ª–∞"
            }
            with open('data/error.json', 'w') as f:
                json.dump(error_info, f, ensure_ascii=False, indent=2)
            exit(1)
        EOF
    
    # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON —Ñ–∞–π–ª—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      run: |
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ data:"
        ls -la data/ || echo "–ü–∞–ø–∫–∞ data –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
        git add data/
        
        # –ö–æ–º–º–∏—Ç–∏–º, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --staged --quiet; then
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          git commit -m "üìä –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã $(date '+%d.%m.%Y %H:%M')"
          git push
          echo "‚úÖ JSON —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
        fi
