name: üìä –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Excel –≤ JSON

on:
  workflow_dispatch:

jobs:
  convert-excel:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: ‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      uses: actions/checkout@v3
    
    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # 3. –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ó–ê–í–ò–°–ò–ú–û–°–¢–ò (—ç—Ç–æ–≥–æ —à–∞–≥–∞ –Ω–µ –±—ã–ª–æ!)
    - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: pip install pandas openpyxl xlrd
    
    # 4. –°–∫–∞—á–∏–≤–∞–µ–º Excel
    - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º Excel –∏–∑ VK –û–±–ª–∞–∫–∞
      run: |
        # –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–≤–æ—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        wget -O data.xlsx "https://cloud.mail.ru/public/4Nef/r6uipVAxF?download=1"
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª:"
        file data.xlsx || true
        echo "–†–∞–∑–º–µ—Ä: $(stat -c%s data.xlsx) –±–∞–π—Ç"
    
    # 5. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JSON
    - name: üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Excel ‚Üí JSON
      run: |
        python << 'EOF'
        import pandas as pd
        import os
        
        os.makedirs('data', exist_ok=True)
        
        try:
            # –ü—Ä–æ–±—É–µ–º —á–∏—Ç–∞—Ç—å –∫–∞–∫ Excel
            xls = pd.ExcelFile('data.xlsx', engine='openpyxl')
            print(f"‚úÖ –£—Å–ø–µ—Ö! –õ–∏—Å—Ç—ã: {xls.sheet_names}")
            
            for sheet in xls.sheet_names:
                df = pd.read_excel(xls, sheet_name=sheet)
                df = df.dropna(how='all')
                
                if not df.empty:
                    json_name = sheet.lower().replace(' ', '_')
                    df.to_json(f'data/{json_name}.json', orient='records', force_ascii=False, indent=2)
                    print(f"üíæ –°–æ–∑–¥–∞–Ω: data/{json_name}.json ({len(df)} —Å—Ç—Ä–æ–∫)")
                else:
                    print(f"‚ö†Ô∏è –õ–∏—Å—Ç '{sheet}' –ø—É—Å—Ç")
                    
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
            with open('data/error.txt', 'w') as f:
                f.write(f"–û—à–∏–±–∫–∞: {str(e)}\n")
                f.write("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è Excel —Ñ–∞–π–ª–æ–º, –∞ –Ω–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π.\n")
            exit(1)
        EOF
    
    # 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ data:"
        ls -la data/ || echo "–ü–∞–ø–∫–∞ data –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
        
        git add data/
        
        if git diff --staged --quiet; then
          echo "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        else
          git commit -m "üìä –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã $(date '+%d.%m.%Y %H:%M')"
          git push
        fi
