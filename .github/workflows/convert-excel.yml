name: üìä –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Excel –≤ JSON

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  convert-excel:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚¨áÔ∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      uses: actions/checkout@v3
    
    - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º Excel –∏–∑ VK –û–±–ª–∞–∫–∞
      run: |
        # –í–ê–®–ê –°–°–´–õ–ö–ê - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é!
        wget -O data.xlsx "https://cloud.mail.ru/public/4Nef/r6uipVAxF?download=1"
        echo "–§–∞–π–ª —Å–∫–∞—á–∞–Ω. –¢–∏–ø:"
        file data.xlsx
    
    - name: üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Excel ‚Üí JSON
      run: |
        python << 'EOF'
        import pandas as pd
        import os
        
        os.makedirs('data', exist_ok=True)
        
        try:
            # –ß–∏—Ç–∞–µ–º Excel
            xls = pd.ExcelFile('data.xlsx', engine='openpyxl')
            print(f"‚úÖ –õ–∏—Å—Ç—ã –≤ —Ñ–∞–π–ª–µ: {xls.sheet_names}")
            
            for sheet in xls.sheet_names:
                df = pd.read_excel(xls, sheet_name=sheet)
                df = df.dropna(how='all')
                
                if not df.empty:
                    output_file = f'data/{sheet.lower()}.json'
                    df.to_json(output_file, orient='records', force_ascii=False, indent=2)
                    print(f"üíæ –°–æ–∑–¥–∞–Ω: {output_file} ({len(df)} —Å—Ç—Ä–æ–∫)")
                else:
                    print(f"‚ö†Ô∏è –õ–∏—Å—Ç '{sheet}' –ø—É—Å—Ç")
                    
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            with open('data/error.txt', 'w') as f:
                f.write(str(e))
            exit(1)
        EOF
    
    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add data/
        
        if git diff --staged --quiet; then
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        else
          git commit -m "üìä –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã $(date '+%d.%m.%Y %H:%M')"
          git push
        fi
